{% extends 'accounts/admin_base.html' %}
{% block title %}Manage Fees - {{ bank.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Manage Fees</h1>
      <p class="text-gray-600">{{ bank.name }}</p>
    </div>
    <div class="flex gap-2">
      <a href="{% url 'Bank:bank_detail' bank.id %}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg shadow font-medium transition-all">
        <i class="fas fa-arrow-left mr-2"></i>Back to Bank
      </a>
      <a href="{% url 'Bank:viewbanks' %}" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg shadow font-medium transition-all">
        <i class="fas fa-list mr-2"></i>All Banks
      </a>
    </div>
  </div>

    <form method="post" novalidate>
      {% csrf_token %}
      {{ formset.management_form }}
      
      {% if formset.non_form_errors %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4">
        <strong class="font-bold">Formset Errors:</strong>
        <ul class="list-disc list-inside">
          {% for error in formset.non_form_errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      
      {% if formset.errors %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4">
        <strong class="font-bold">Form Errors:</strong>
        <ul class="list-disc list-inside">
          {% for form_errors in formset.errors %}
            {% if form_errors %}
              {% for field, errors in form_errors.items %}
                {% for error in errors %}
                  <li>Row {{ forloop.parentloop.counter }}: {{ field }} - {{ error }}</li>
                {% endfor %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      
      <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold flex items-center text-gray-800">
            <i class="fas fa-receipt text-2xl mr-3 text-purple-600"></i>State / Case Type Fees
          </h2>
          <button type="button" id="add-row" class="px-4 py-2 text-sm bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg shadow-lg font-medium transition-all">
            <i class="fas fa-plus-circle mr-2"></i>Add Row
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm" id="fees-table">
            <thead class="bg-gray-50">
              <tr class="text-left border-b-2 border-gray-200">
                <th class="py-3 px-3 font-semibold text-gray-700">State</th>
                <th class="py-3 px-3 font-semibold text-gray-700">Case Type</th>
                <th class="py-3 px-3 font-semibold text-gray-700">Fee</th>
                <th class="py-3 px-3 font-semibold text-gray-700">Delete</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              {% for form in formset.forms %}
                <tr class="fee-row align-top hover:bg-purple-50/30 transition-colors">
                  <!-- Hidden fields for formset -->
                  <td style="display:none;">
                    {{ form.id }}
                    {{ form.DELETE }}
                  </td>
                  <td class="py-2 px-3">
                    {{ form.state }}
                    {% if form.state.errors %}
                      <div class="text-red-600 text-xs mt-1">{{ form.state.errors.0 }}</div>
                    {% endif %}
                  </td>
                  <td class="py-2 px-3">
                    {{ form.casetype }}
                    {% if form.casetype.errors %}
                      <div class="text-red-600 text-xs mt-1">{{ form.casetype.errors.0 }}</div>
                    {% endif %}
                  </td>
                  <td class="py-2 px-3">
                    {{ form.fees }}
                    {% if form.fees.errors %}
                      <div class="text-red-600 text-xs mt-1">{{ form.fees.errors.0 }}</div>
                    {% endif %}
                    {% if form.non_field_errors %}
                      <div class="text-red-600 text-xs mt-1">{{ form.non_field_errors.0 }}</div>
                    {% endif %}
                  </td>
                  <td class="py-2 px-3">
                    <button type="button" class="delete-row text-red-600 hover:text-red-700 font-bold">
                      <i class="fas fa-times-circle"></i>
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-4">Add fee mappings for the states where the bank operates. Click "Add Row" to add multiple state/case type combinations.</p>
      </div>

      <div class="mt-6 flex gap-4">
        <button type="submit" class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-semibold rounded-xl shadow-lg transition-all">
          <i class="fas fa-save mr-2"></i>Save Fees
        </button>
        <a href="{% url 'Bank:viewbanks' %}" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-xl shadow transition-all">
          <i class="fas fa-arrow-left mr-2"></i>Back
        </a>
      </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const addBtn = document.getElementById('add-row');
  const tableBody = document.querySelector('#fees-table tbody');
  const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');

  function cloneEmptyRow(formIndex) {
    const firstRow = tableBody.querySelector('tr.fee-row');
    const newRow = firstRow.cloneNode(true);
    
    // Remove all error messages from the cloned row
    newRow.querySelectorAll('.text-red-600').forEach(el => el.remove());
    
    // Clear all input and select values
    newRow.querySelectorAll('select, input[type="number"], input[type="text"]').forEach(el => { 
      el.value = '';
      // Remove any error styling
      el.classList.remove('border-red-500');
    });
    
    // Handle hidden inputs (like DELETE and ID fields)
    newRow.querySelectorAll('input[type="hidden"]').forEach(el => {
      // Clear ID field for new rows
      if (el.name.includes('-id')) {
        el.value = '';
      }
      // Ensure DELETE is unchecked for new rows
      if (el.name.includes('-DELETE')) {
        el.value = '';
      }
    });
    
    // Update form field names and IDs with new index
    newRow.querySelectorAll('select, input').forEach(el => {
      ['name', 'id'].forEach(attr => {
        const val = el.getAttribute(attr);
        if (val) {
          el.setAttribute(attr, val.replace(/-\d+-/, '-' + formIndex + '-'));
        }
      });
    });
    
    return newRow;
  }

  addBtn.addEventListener('click', function() {
    const idx = parseInt(totalFormsInput.value, 10);
    const newRow = cloneEmptyRow(idx);
    tableBody.appendChild(newRow);
    totalFormsInput.value = idx + 1;
  });

  tableBody.addEventListener('click', function(e) {
    if (e.target.classList.contains('delete-row') || e.target.closest('.delete-row')) {
      const row = e.target.closest('tr');
      const deleteInput = row.querySelector('input[name$="-DELETE"]');
      
      if (deleteInput) {
        // Mark for deletion instead of removing from DOM
        deleteInput.value = 'on';
        row.style.opacity = '0.3';
        row.style.textDecoration = 'line-through';
        const deleteBtn = row.querySelector('.delete-row');
        deleteBtn.innerHTML = '<i class="fas fa-undo"></i>';
        deleteBtn.classList.add('undo-delete');
        deleteBtn.classList.remove('delete-row');
      } else {
        // New row without ID can be safely removed
        row.remove();
        // Re-index remaining rows
        let i = 0;
        tableBody.querySelectorAll('tr.fee-row').forEach(r => {
          r.querySelectorAll('select, input').forEach(el => {
            ['name', 'id'].forEach(attr => {
              const val = el.getAttribute(attr);
              if (val) {
                el.setAttribute(attr, val.replace(/-\d+-/, '-' + i + '-'));
              }
            });
          });
          i++;
        });
        totalFormsInput.value = i;
      }
    } else if (e.target.classList.contains('undo-delete') || e.target.closest('.undo-delete')) {
      // Undo deletion
      const row = e.target.closest('tr');
      const deleteInput = row.querySelector('input[name$="-DELETE"]');
      if (deleteInput) {
        deleteInput.value = '';
        row.style.opacity = '1';
        row.style.textDecoration = 'none';
        const undoBtn = row.querySelector('.undo-delete');
        undoBtn.innerHTML = '<i class="fas fa-times-circle"></i>';
        undoBtn.classList.add('delete-row');
        undoBtn.classList.remove('undo-delete');
      }
    }
  });
})();
</script>
{% endblock %}

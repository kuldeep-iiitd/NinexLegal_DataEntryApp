{% extends 'accounts/admin_base.html' %}
{% load static %}

{% block title %}Create New Case{% endblock %}

{% block content %}
<div class="flex-1 p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header Section -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-2 flex items-center">
                <i class="fas fa-folder-plus mr-3"></i>
                Create New Case
            </h1>
            <p class="text-purple-100">Fill in the case details and assign an advocate if documents are ready</p>
        </div>

        <!-- Main Form Card -->
        <div class="bg-white/20 backdrop-blur-md rounded-2xl shadow-2xl p-8 border border-white/30">
            <style>
                .form-control { 
                    width: 100%; 
                    border: 1px solid rgba(255, 255, 255, 0.4); 
                    border-radius: 0.5rem; 
                    padding: 0.75rem;
                    background: rgba(255, 255, 255, 0.9);
                    color: #1f2937;
                    backdrop-filter: blur(10px);
                    font-weight: 500;
                }
                .form-control::placeholder {
                    color: rgba(31, 41, 55, 0.6);
                }
                .form-control:focus {
                    outline: none;
                    border-color: #1e3a8a;
                    background: rgba(255, 255, 255, 1);
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
                }
                input[type="checkbox"] { 
                    width: 1.25rem; 
                    height: 1.25rem;
                }
                select.form-control {
                    appearance: none;
                    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%231f2937' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
                    background-position: right 0.5rem center;
                    background-repeat: no-repeat;
                    background-size: 1.5em 1.5em;
                    padding-right: 2.5rem;
                    color: #1f2937;
                    font-weight: 600;
                }
                select.form-control option {
                    background: white;
                    color: #1f2937;
                    font-weight: 500;
                    padding: 0.5rem;
                }
            </style>
                <form method="post" id="caseForm" class="space-y-8">
                    {% csrf_token %}
                    
                    
                    <!-- Basic Information Section -->
                    <div class="space-y-6 mb-8">
                        <div class="border-l-4 border-purple-300 pl-4">
                            <h3 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-info-circle mr-2"></i>
                                Basic Information
                            </h3>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="{{ form.applicant_name.id_for_label }}" class="block text-white font-medium flex items-center">
                                    <i class="fas fa-user mr-2 text-purple-300"></i>
                                    Applicant Name <span class="text-red-300">*</span>
                                </label>
                                <input type="text" name="{{ form.applicant_name.name }}" id="{{ form.applicant_name.id_for_label }}" 
                                       class="form-control" 
                                       placeholder="Enter applicant name" value="{{ form.applicant_name.value|default:'' }}">
                                {% if form.applicant_name.errors %}
                                    <p class="text-red-300 text-sm mt-1">{{ form.applicant_name.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="{{ form.case_number.id_for_label }}" class="block text-white font-medium flex items-center">
                                    <i class="fas fa-hashtag mr-2 text-purple-300"></i>
                                    Case Number <span class="text-red-300">*</span>
                                </label>
                                <input type="text" name="{{ form.case_number.name }}" id="{{ form.case_number.id_for_label }}" 
                                       class="form-control" 
                                       placeholder="Enter case number" value="{{ form.case_number.value|default:'' }}">
                                {% if form.case_number.errors %}
                                    <p class="text-red-300 text-sm mt-1">{{ form.case_number.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="{{ form.bank.id_for_label }}" class="block text-white font-medium flex items-center">
                                    <i class="fas fa-university mr-2 text-purple-300"></i>
                                    Bank/NBFC Name <span class="text-red-300">*</span>
                                </label>
                                <input type="text" id="bankFilterInput" placeholder="Type to filter banks..." class="form-control mb-2" autocomplete="off">
                                <select name="{{ form.bank.name }}" id="{{ form.bank.id_for_label }}" class="form-control">
                                    <option value="">Select a Bank/NBFC</option>
                                    {% for choice in form.bank.field.queryset %}
                                        <option value="{{ choice.pk }}" {% if form.bank.value == choice.pk|stringformat:"s" %}selected{% endif %}>{{ choice.name }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.bank.errors %}
                                    <p class="text-red-300 text-sm mt-1">{{ form.bank.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="{{ form.case_type.id_for_label }}" class="block text-white font-medium flex items-center">
                                    <i class="fas fa-folder-open mr-2 text-purple-300"></i>
                                    Case Type <span class="text-red-300">*</span>
                                </label>
                                <input type="text" id="caseTypeFilterInput" placeholder="Type to filter case types..." class="form-control mb-2" autocomplete="off">
                                <select name="{{ form.case_type.name }}" id="{{ form.case_type.id_for_label }}" class="form-control">
                                    <option value="">Select a Case Type</option>
                                    {% for choice in form.case_type.field.queryset %}
                                        <option value="{{ choice.pk }}" {% if form.case_type.value == choice.pk|stringformat:"s" %}selected{% endif %}>{{ choice.name }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.case_type.errors %}
                                    <p class="text-red-300 text-sm mt-1">{{ form.case_type.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Document Status Section -->
                    <div class="space-y-6 mb-8">
                        <div class="border-l-4 border-yellow-300 pl-4">
                            <h3 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-file-alt mr-2"></i>
                                Document Status
                            </h3>
                        </div>
                        
                        <!-- Quotation Toggle -->
                        <div class="bg-white/15 rounded-xl p-6 border border-white/30">
                            <div class="flex items-start space-x-4">
                                <input type="checkbox" name="{{ form.is_quotation.name }}" id="{{ form.is_quotation.id_for_label }}" class="h-5 w-5 mt-1" {% if form.is_quotation.value %}checked{% endif %}>
                                <div class="flex-1">
                                    <label for="{{ form.is_quotation.id_for_label }}" class="text-lg font-semibold text-white cursor-pointer">This is only a quotation (no documents yet)</label>
                                    <p class="text-sm text-purple-100 mt-1">Use this when you are creating a preliminary case record with a quoted price but documents are not yet collected.</p>
                                    <div id="quotationPriceWrapper" class="mt-4 hidden">
                                        <label for="{{ form.quotation_price.id_for_label }}" class="block text-white font-medium mb-2 flex items-center">
                                            <i class="fas fa-dollar-sign mr-2 text-purple-300"></i>
                                            Quoted Price <span class="text-red-300">*</span>
                                        </label>
                                        <input type="number" step="0.01" name="{{ form.quotation_price.name }}" id="{{ form.quotation_price.id_for_label }}" value="{{ form.quotation_price.value|default:'' }}" class="form-control" placeholder="Enter quoted price">
                                        {% if form.quotation_price.errors %}
                                            <p class="text-red-300 text-sm mt-2">{{ form.quotation_price.errors.0 }}</p>
                                        {% endif %}
                                        <div class="bg-blue-500/30 border-l-4 border-blue-300 p-4 rounded-r-lg mt-3">
                                            <div class="flex items-center">
                                                <i class="fas fa-info-circle text-blue-100 mr-2"></i>
                                                <p class="text-white text-sm">Quotation cases cannot have documents or advocates assigned yet. Finalize later when documents arrive.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white/15 rounded-xl p-6 border border-white/30">
                            <div class="flex items-center space-x-4">
                                <input type="checkbox" name="{{ form.documents_present.name }}" id="{{ form.documents_present.id_for_label }}" 
                                       class="h-5 w-5" 
                                       {% if form.documents_present.value %}checked{% endif %}>
                                <label for="{{ form.documents_present.id_for_label }}" class="text-lg font-semibold text-white cursor-pointer flex items-center">
                                    <i class="fas fa-check-circle text-green-300 mr-2 text-xl"></i>
                                    Documents are present and ready for assignment
                                </label>
                            </div>
                            {% if form.documents_present.errors %}
                                <p class="text-red-300 text-sm mt-2">{{ form.documents_present.errors.0 }}</p>
                            {% endif %}
                            <div class="mt-4 flex items-center">
                                <input type="checkbox" name="{{ form.assign_to_admin.name }}" id="{{ form.assign_to_admin.id_for_label }}" class="h-5 w-5" {% if form.assign_to_admin.value %}checked{% endif %}>
                                <label for="{{ form.assign_to_admin.id_for_label }}" class="ml-3 text-sm font-semibold text-white cursor-pointer">Assign to Admin (initials AD)</label>
                            </div>
                        </div>
                    </div>

                    <!-- Advocate Assignment Section -->
                    <div id="advocateSection" class="space-y-6 mb-8 hidden">
                        <div class="border-l-4 border-green-300 pl-4">
                            <h3 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-user-tie mr-2"></i>
                                Advocate Assignment
                            </h3>
                        </div>
                        
                        <div class="bg-white/15 rounded-xl p-6 border border-white/30">
                            <div class="space-y-4">
                                <label for="{{ form.assigned_advocate.id_for_label }}" class="block text-white font-semibold flex items-center">
                                    <i class="fas fa-gavel mr-2 text-purple-300"></i>
                                    Select Advocate <span class="text-red-300">*</span>
                                </label>
                                <select name="{{ form.assigned_advocate.name }}" id="{{ form.assigned_advocate.id_for_label }}" class="form-control">
                                    <option value="">Select an Advocate</option>
                                    {% for advocate in form.assigned_advocate.field.queryset %}
                                        <option value="{{ advocate.pk }}" {% if form.assigned_advocate.value == advocate.pk|stringformat:"s" %}selected{% endif %}>{{ advocate.name }} ({{ advocate.employee_id }})</option>
                                    {% endfor %}
                                </select>
                                {% if form.assigned_advocate.errors %}
                                    <p class="text-red-300 text-sm mt-2">{{ form.assigned_advocate.errors.0 }}</p>
                                {% endif %}
                                <div class="bg-blue-500/30 border-l-4 border-blue-300 p-4 rounded-r-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-blue-100 mr-2"></i>
                                        <p class="text-white text-sm">Since documents are present, you can assign an advocate immediately.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- No Documents Info -->
                    <div id="noDocumentsInfo" class="bg-orange-500/30 border border-orange-400/60 rounded-xl p-6 mb-8">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-orange-100 text-2xl mr-3 flex-shrink-0 mt-1"></i>
                            <div>
                                <h4 class="text-lg font-semibold text-white mb-2">No Documents Available</h4>
                                <p class="text-orange-50">The case will be saved with "Pending Assignment" status. You can assign an advocate later when documents become available.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="bg-red-500/20 border border-red-400/50 rounded-xl p-4 mb-8">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle text-red-200 mr-2"></i>
                                <p class="text-red-100">{{ form.non_field_errors.0 }}</p>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 pt-6 border-t border-white/20">
                        <a href="{% url 'view_cases' %}" class="inline-flex items-center px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-lg border border-white/20 transition duration-300">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back to Cases
                        </a>
                        <button type="submit" class="inline-flex items-center px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-lg hover:shadow-lg transition duration-300">
                            <i class="fas fa-check mr-2"></i>
                            Create Case
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // In-place filtering for Bank and Case Type selects
    const bankFilterInput = document.getElementById('bankFilterInput');
    const bankSelect = document.getElementById('{{ form.bank.id_for_label }}');
    const caseTypeFilterInput = document.getElementById('caseTypeFilterInput');
    const caseTypeSelect = document.getElementById('{{ form.case_type.id_for_label }}');

    function buildCache(selectEl){
        // Cache all options except the first placeholder
        const all = [];
        for (let i = 0; i < selectEl.options.length; i++){
            const opt = selectEl.options[i];
            all.push({value: opt.value, text: opt.text});
        }
        return all;
    }

    const bankOptionsCache = buildCache(bankSelect);
    const caseTypeOptionsCache = buildCache(caseTypeSelect);

    function filterSelect(selectEl, cache, query){
        const selectedVal = selectEl.value;
        const q = (query || '').toLowerCase();
        // Clear
        while (selectEl.options.length) selectEl.remove(0);
        // Rebuild with filtered
        cache.forEach(({value, text}) => {
            if (!q || text.toLowerCase().includes(q)){
                const opt = document.createElement('option');
                opt.value = value; opt.text = text;
                if (value === selectedVal) opt.selected = true;
                selectEl.add(opt);
            }
        });
        // If selected disappeared due to filter, reset to first
        if (selectEl.selectedIndex === -1 && selectEl.options.length){
            selectEl.selectedIndex = 0;
        }
    }

    if (bankFilterInput){
        bankFilterInput.addEventListener('input', () => filterSelect(bankSelect, bankOptionsCache, bankFilterInput.value));
    }
    if (caseTypeFilterInput){
        caseTypeFilterInput.addEventListener('input', () => filterSelect(caseTypeSelect, caseTypeOptionsCache, caseTypeFilterInput.value));
    }
    const documentsCheckbox = document.getElementById('{{ form.documents_present.id_for_label }}');
    const advocateSection = document.getElementById('advocateSection');
    const noDocumentsInfo = document.getElementById('noDocumentsInfo');
    const advocateSelect = document.getElementById('{{ form.assigned_advocate.id_for_label }}');
    const quotationCheckbox = document.getElementById('{{ form.is_quotation.id_for_label }}');
    const quotationPriceWrapper = document.getElementById('quotationPriceWrapper');
    const quotationPriceInput = document.getElementById('{{ form.quotation_price.id_for_label }}');

    const assignToAdminCheckbox = document.getElementById('{{ form.assign_to_admin.id_for_label }}');

    function hasAdvocateSelected(){
        return advocateSelect && advocateSelect.value && advocateSelect.value !== '';
    }

    function toggleAdvocateSection() {
        const assigningToAdmin = assignToAdminCheckbox && assignToAdminCheckbox.checked;
        const showAdvocatePick = !quotationCheckbox.checked && !assigningToAdmin;
        if (showAdvocatePick && documentsCheckbox.checked) {
            advocateSection.classList.remove('hidden');
            noDocumentsInfo.classList.add('hidden');
            advocateSelect.required = true;
        } else {
            advocateSection.classList.add('hidden');
            // Hide the info if either assigning to admin or an advocate is chosen while not a quotation
            if (!quotationCheckbox.checked && (assigningToAdmin || hasAdvocateSelected())) {
                noDocumentsInfo.classList.add('hidden');
            } else {
                noDocumentsInfo.classList.remove('hidden');
            }
            advocateSelect.required = false;
            advocateSelect.value = '';
        }
    }

    function toggleQuotation() {
        if (quotationCheckbox.checked) {
            quotationPriceWrapper.classList.remove('hidden');
            quotationPriceInput.required = true;
            // Disable documents checkbox and advocate when quotation
            documentsCheckbox.checked = false;
            documentsCheckbox.disabled = true;
            toggleAdvocateSection();
            noDocumentsInfo.classList.add('hidden');
        } else {
            quotationPriceWrapper.classList.add('hidden');
            quotationPriceInput.required = false;
            documentsCheckbox.disabled = false;
            toggleAdvocateSection();
        }
    }

    documentsCheckbox.addEventListener('change', toggleAdvocateSection);
    if (assignToAdminCheckbox) assignToAdminCheckbox.addEventListener('change', toggleAdvocateSection);
    quotationCheckbox.addEventListener('change', toggleQuotation);
    toggleAdvocateSection(); // Initial call
    toggleQuotation();
});
</script>
{% endblock %}

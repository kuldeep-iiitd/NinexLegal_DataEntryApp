<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Details - {{ case.case_number }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            {% if is_admin %}
                background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            {% elif is_sro %}
                background: linear-gradient(to bottom right, #f59e0b, #d97706);
            {% else %}
                background: linear-gradient(to bottom right, #1e40af, #3b82f6);
            {% endif %}
            min-height: 100vh;
        }
    </style>
</head>
<body>
<div class="min-h-screen py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header Section -->
        <div class="flex flex-col sm:flex-row justify-between items-start mb-8">
            <div class="flex items-center mb-4 sm:mb-0">
                <div class="bg-white/20 backdrop-blur-md p-3 rounded-xl mr-4 border border-white/30">
                    <i class="fas fa-file-alt text-3xl text-white"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-white drop-shadow-lg">Case Details</h1>
                    <p class="text-white text-lg">{{ case.case_number }} - {{ case.applicant_name }}</p>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <a href="{% if is_admin %}{% url 'view_cases' %}{% else %}{% url 'dashboard' %}{% endif %}" class="inline-flex items-center px-6 py-3 bg-white/30 backdrop-blur-md border border-white/40 text-white font-semibold rounded-xl hover:bg-white/40 transition-all duration-200 shadow-lg">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to {% if is_admin %}Cases{% else %}Dashboard{% endif %}
                </a>
            </div>
        </div>

        {# Banner prompting advocate to upload final document after SRO receipt #}
        {% if case.assigned_advocate and request.user.employee and request.user.employee.id == case.assigned_advocate.id %}
        {% if case.status == 'document_pending' or case.status == 'sro_document_pending' %}
        <div class="mb-6 bg-blue-500/30 border border-blue-400/60 rounded-xl p-5 backdrop-blur-md flex items-center justify-between">
            <div class="text-white">
                <div class="font-semibold text-lg">SRO receipt uploaded</div>
                <div class="text-blue-100">Please upload the final document and set final status.</div>
            </div>
            <div class="flex gap-2">
                <a href="{% url 'case_finalize_with_document' case.id %}" class="px-5 py-2.5 rounded-lg bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-semibold hover:from-indigo-700 hover:to-blue-700 transition-all">Upload Final & Status</a>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Case Information -->
            <div class="lg:col-span-2 space-y-8">
                        {% if is_finalized %}
                        <div class="bg-red-500/30 border border-red-400/60 text-white p-5 rounded-xl flex items-start gap-3 backdrop-blur-md">
                            <i class="fas fa-lock text-2xl mt-1"></i>
                            <div>
                                <p class="font-semibold text-lg">Case Closed</p>
                                <p class="text-red-100">This case has been finalized ({{ case.get_status_display }}). Core details and new works are locked. You may still replace the final document if needed.</p>
                            </div>
                        </div>
                        {% endif %}
                <!-- Basic Information Card -->
                <div class="bg-white/20 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/30">
                    <div class="bg-gradient-to-r from-purple-500/80 to-indigo-600/80 px-6 py-5 border-b border-white/20">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-info-circle text-2xl mr-3"></i>
                            Case Information
                        </h2>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="flex items-center p-4 bg-gray-800/60 backdrop-blur-sm rounded-lg border border-white/20">
                                    <div class="bg-blue-500 rounded-lg p-2.5 mr-3">
                                        <i class="fas fa-hashtag text-white"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300 font-medium">Case Number</p>
                                        <p class="font-bold text-white text-lg">{{ case.case_number }}</p>
                                    </div>
                                </div>
                                {% if is_active_quotation or case.status == 'quotation' %}
                                <div class="flex items-center p-4 bg-gray-800/60 backdrop-blur-sm rounded-lg border border-white/20">
                                    <div class="bg-teal-500 rounded-lg p-2.5 mr-3">
                                        <i class="fas fa-dollar-sign text-white"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300 font-medium">Quoted Price</p>
                                        <p class="font-bold text-white text-lg">₹ {{ case.quotation_price|default:'--' }}</p>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <div class="flex items-center p-4 bg-gray-800/60 backdrop-blur-sm rounded-lg border border-white/20">
                                    <div class="bg-purple-500 rounded-lg p-2.5 mr-3">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300 font-medium">Applicant Name</p>
                                        <p class="font-bold text-white text-lg">{{ case.applicant_name }}</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center p-4 bg-gray-800/60 backdrop-blur-sm rounded-lg border border-white/20">
                                    <div class="bg-green-500 rounded-lg p-2.5 mr-3">
                                        <i class="fas fa-building text-white"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300 font-medium">Bank/NBFC</p>
                                        <p class="font-semibold text-white">{{ case.bank.name }} {% if case.bank.state %}<span class="text-gray-200">({{ case.bank.state }})</span>{% endif %}</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center p-4 bg-gray-800/70 backdrop-blur-sm rounded-lg border border-white/20">
                                    <div class="bg-orange-500 rounded-lg p-2.5 mr-3">
                                        <i class="fas fa-folder text-white"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300 font-medium">Case Type</p>
                                        <p class="font-bold text-white text-lg">{{ case.case_type.name }}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="flex items-center p-4 bg-gray-800/70 backdrop-blur-sm rounded-lg border border-white/20">
                                    <div class="{% if case.status == 'pending_assignment' %}bg-yellow-500{% elif case.status == 'document_pending' %}bg-blue-500{% elif case.status == 'sro_document_pending' %}bg-cyan-500{% elif case.status == 'on_hold' %}bg-indigo-500{% elif case.status == 'positive' %}bg-green-600{% elif case.status == 'negative' %}bg-red-500{% else %}bg-gray-500{% endif %} rounded-lg p-2.5 mr-3">
                                        <i class="fas fa-clipboard-check text-white"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300 font-medium">Status</p>
                                        {% if case.status == 'pending_assignment' %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-yellow-400/80 text-yellow-900">Pending Assignment</span>
                                        {% elif case.status == 'document_pending' %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-400/80 text-blue-900">Document Pending</span>
                                        {% elif case.status == 'sro_document_pending' %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-cyan-400/80 text-cyan-900">SRO Document Pending</span>
                                        {% elif case.status == 'on_hold' %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-400/80 text-blue-900">On Hold</span>
                                        {% elif case.status == 'positive' %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-green-400/80 text-green-900">Positive</span>
                                        {% elif case.status == 'negative' %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-red-400/80 text-red-900">Negative</span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-400/80 text-gray-900">{{ case.get_status_display }}</span>
                                        {% endif %}
                                        {% if case.forwarded_to_sro %}
                                            <span class="ml-2 inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-indigo-400/80 text-indigo-900">Forwarded to SRO</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="flex items-center p-4 bg-gray-800/70 backdrop-blur-sm rounded-lg border border-white/20">
                                    <div class="{% if case.assigned_advocate %}bg-teal-500{% else %}bg-gray-500{% endif %} rounded-lg p-2.5 mr-3">
                                        <i class="fas fa-user-tie text-white"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300 font-medium">Advocate Assigned</p>
                                        {% if case.assigned_advocate %}
                                            <p class="font-bold text-white text-lg">{{ case.assigned_advocate.name }}</p>
                                            <p class="text-xs text-gray-300">ID: {{ case.assigned_advocate.employee_id }}</p>
                                        {% else %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-400/80 text-gray-900">
                                                Not Assigned
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="flex items-center p-4 bg-gray-800/70 backdrop-blur-sm rounded-lg border border-white/20">
                                    <div class="bg-indigo-500 rounded-lg p-2.5 mr-3">
                                        <i class="fas fa-calendar text-white"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-300 font-medium">Assigned Date</p>
                                        <p class="font-semibold text-white">{{ case.created_at|date:"M d, Y H:i A" }}</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center p-4 bg-gray-800/70 backdrop-blur-sm rounded-lg border border-white/20">
                                    <div class="bg-gray-500/80 rounded-lg p-2.5 mr-3">
                                        <i class="fas fa-sync-alt text-white"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-200">Last Updated</p>
                                        <p class="font-semibold text-white">{{ case.updated_at|date:"M d, Y H:i A" }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Property Details Card -->
                {% if case.property_address or case.state or case.district or case.tehsil %}
                <div class="bg-white/20 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/30">
                    <div class="bg-gradient-to-r from-green-500/80 to-emerald-600/80 px-6 py-5 border-b border-white/20">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-map-marker-alt text-2xl mr-3"></i>
                            Property Details
                        </h2>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {% if case.property_address %}
                            <div class="md:col-span-2">
                                <div class="p-4 bg-green-500/20 rounded-lg border border-green-400/40">
                                    <h4 class="font-semibold text-green-200 mb-2">Property Address</h4>
                                    <p class="text-white">{{ case.property_address }}</p>
                                </div>
                            </div>
                            {% endif %}
                            {% if case.state %}
                            <div class="p-3 bg-gray-800/70 backdrop-blur-sm rounded-lg border border-white/20">
                                <p class="text-sm text-gray-200">State</p>
                                <p class="font-semibold text-white">{{ case.state }}</p>
                            </div>
                            {% endif %}
                            {% if case.district %}
                            <div class="p-3 bg-gray-800/70 backdrop-blur-sm rounded-lg border border-white/20">
                                <p class="text-sm text-gray-200">District</p>
                                <p class="font-semibold text-white">{{ case.district }}</p>
                            </div>
                            {% endif %}
                            {% if case.tehsil %}
                            <div class="p-3 bg-gray-800/70 backdrop-blur-sm rounded-lg border border-white/20">
                                <p class="text-sm text-gray-200">Tehsil</p>
                                <p class="font-semibold text-white">{{ case.tehsil }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Documents Section -->
                {% if not is_active_quotation %}
                {% if receipt_docs or final_docs %}
                <div class="bg-white/20 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/30">
                    <div class="bg-gradient-to-r from-indigo-500/80 to-blue-600/80 px-6 py-5 border-b border-white/20">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-file-upload text-2xl mr-3"></i>
                            Uploaded Documents
                        </h2>
                    </div>
                    <div class="p-6">
                        {% if receipt_docs %}
                        <div class="mb-6">
                            <h3 class="text-sm font-semibold text-gray-200 mb-3">Receipt Document</h3>
                            <ul class="divide-y divide-white/10">
                                {% for doc in receipt_docs %}
                                <li class="py-3 flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-white">{{ doc.description|default:"Receipt" }}</p>
                                        <p class="text-xs text-gray-200">Uploaded {{ doc.uploaded_at|date:'M d, Y H:i' }} {% if doc.uploaded_by %}by {% firstof doc.uploaded_by.name doc.uploaded_by.user.username 'Unknown' %}{% endif %}</p>
                                    </div>
                                    <a href="{{ doc.file.url }}" target="_blank" class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-emerald-600 to-green-600 text-white text-xs font-semibold rounded-lg hover:from-emerald-700 hover:to-green-700 transition-all">View</a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-200">Final Documents</h3>
                            {% if not is_sro %}
                            <a href="{% url 'case_replace_final_document' case.id %}" class="inline-flex items-center px-3 py-1.5 bg-orange-600 hover:bg-orange-700 text-white text-xs font-semibold rounded-lg transition-all">
                                <i class="fas fa-sync-alt mr-1"></i>Replace
                            </a>
                            {% endif %}
                        </div>
                        {% if final_docs %}
                        <ul class="divide-y divide-white/10">
                            {% for doc in final_docs %}
                            <li class="py-3">
                                <div class="flex items-center justify-between mb-1">
                                    <p class="text-sm font-medium text-white">
                                        <i class="fas fa-file-alt mr-1 text-blue-300"></i>
                                        {% if doc.description %}{{ doc.description }}{% else %}{{ doc.file.name|slice:'15:' }}{% endif %}
                                    </p>
                                    <a href="{{ doc.file.url }}" target="_blank" class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-indigo-600 to-blue-600 text-white text-xs font-semibold rounded-lg hover:from-indigo-700 hover:to-blue-700 transition-all">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </a>
                                </div>
                                <p class="text-xs text-gray-300">Uploaded {{ doc.uploaded_at|date:'M d, Y H:i' }} {% if doc.uploaded_by %}by {% firstof doc.uploaded_by.name doc.uploaded_by.user.username 'Unknown' %}{% endif %}</p>
                            </li>
                            {% empty %}
                            <li class="py-3 text-sm text-gray-200">No final documents uploaded yet.</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-sm text-gray-200">No final documents uploaded yet.</p>
                        {% endif %}
                        
                        {% if additional_docs %}
                        <div class="mt-6 pt-6 border-t border-white/10">
                            <h3 class="text-sm font-semibold text-gray-200 mb-3">Additional Documents</h3>
                            <ul class="divide-y divide-white/10">
                                {% for doc in additional_docs %}
                                <li class="py-3">
                                    <div class="flex items-center justify-between mb-1">
                                        <p class="text-sm font-medium text-white">
                                            <i class="fas fa-paperclip mr-1 text-purple-300"></i>
                                            {% if doc.description %}{{ doc.description }}{% else %}{{ doc.file.name|slice:'15:' }}{% endif %}
                                        </p>
                                        <a href="{{ doc.file.url }}" target="_blank" class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs font-semibold rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all">
                                            <i class="fas fa-eye mr-1"></i>View
                                        </a>
                                    </div>
                                    <p class="text-xs text-gray-300">Uploaded {{ doc.uploaded_at|date:'M d, Y H:i' }} {% if doc.uploaded_by %}by {% firstof doc.uploaded_by.name doc.uploaded_by.user.username 'Unknown' %}{% endif %}</p>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endif %}

                <!-- Extra Works Section -->
                {% if not is_active_quotation %}
                <div class="bg-white/20 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/30">
                    <div class="bg-gradient-to-r from-cyan-500/80 to-sky-600/80 px-6 py-5 border-b border-white/20 flex items-center justify-between">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-tasks text-2xl mr-3"></i>
                            Additional Works
                        </h2>
                        {% if not is_finalized %}
                            {% if request.user.groups.all.0.name == 'ADMIN' or request.user.groups.all.0.name == 'CO-ADMIN' or request.user.is_superuser %}
                            <a href="{% url 'add_case_work' case.id %}" class="px-4 py-2 bg-white/20 backdrop-blur-sm text-white text-sm font-semibold rounded-lg border border-white/30 hover:bg-white/30 transition-all">Add Work</a>
                            {% endif %}
                        {% endif %}
                    </div>
                    <div class="p-6">
                        {% if case.works.all %}
                        <ul class="divide-y divide-white/10">
                            {% for w in case.works.all %}
                            <li class="py-3 flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-white">{{ w.case_type.name }}</p>
                                    <p class="text-xs text-gray-200">Added {{ w.created_at|date:'M d, Y H:i' }}{% if w.notes %} • {{ w.notes }}{% endif %}</p>
                                </div>
                                <a href="{{ w.document.url }}" target="_blank" class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-cyan-600 to-sky-600 text-white text-xs font-semibold rounded-lg hover:from-cyan-700 hover:to-sky-700 transition-all">View Doc</a>
                            </li>
                            {% empty %}
                            <li class="py-3 text-sm text-gray-200">No extra works added yet.</li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-sm text-gray-200">No extra works added yet.</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Related Child Cases (expanded inline, remove Open link) -->
                {% if case.child_cases.all and not is_active_quotation %}
                <div class="bg-white/20 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/30">
                    <div class="bg-gradient-to-r from-amber-500/80 to-orange-600/80 px-6 py-5 border-b border-white/20">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-link text-2xl mr-3"></i>
                            Linked Property Cases
                        </h2>
                    </div>
                    <div class="p-6 space-y-6">
                        {% for child in case.child_cases.all %}
                        <div class="border border-white/20 rounded-xl p-4 bg-white/10 backdrop-blur-sm">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-2">
                                <div class="mb-2 md:mb-0">
                                    <p class="text-sm font-semibold text-white">{{ child.case_number }} {% if child.legal_reference_number %}<span class="text-xs text-gray-200">({{ child.legal_reference_number }})</span>{% endif %}</p>
                                    <p class="text-[11px] text-gray-200">Created {{ child.created_at|date:'M d, Y' }}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold {% if child.status == 'positive' %}bg-green-400/80 text-green-900{% elif child.status == 'negative' %}bg-red-400/80 text-red-900{% elif child.status == 'pending' %}bg-purple-400/80 text-purple-900{% elif child.status == 'document_pending' %}bg-blue-400/80 text-blue-900{% elif child.status == 'sro_document_pending' %}bg-cyan-400/80 text-cyan-900{% else %}bg-gray-400/80 text-gray-900{% endif %}">{{ child.get_status_display }}</span>
                                    {% if child.forwarded_to_sro %}<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-indigo-400/80 text-indigo-900">SRO</span>{% endif %}
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
                                <div class="md:col-span-1">
                                    <p class="font-medium text-gray-200 mb-1">Address</p>
                                    <p class="text-white whitespace-pre-line">{{ child.property_address|default:'No address provided' }}</p>
                                </div>
                                <div class="space-y-1">
                                    <p class="font-medium text-gray-200">Location</p>
                                    <p class="text-white">State: <span class="font-semibold">{{ child.state|default:'--' }}</span></p>
                                    <p class="text-white">District: <span class="font-semibold">{{ child.district|default:'--' }}</span></p>
                                    <p class="text-white">Tehsil: <span class="font-semibold">{{ child.tehsil|default:'--' }}</span></p>
                                </div>
                                <div class="space-y-1">
                                    <p class="font-medium text-gray-200">Bank / Branch</p>
                                    <p class="text-white">{{ child.bank.name }}{% if child.branch %} / <span class="font-semibold">{{ child.branch.name }}</span>{% endif %}</p>
                                    {% if child.receipt_number %}
                                    <p class="text-white">Receipt: <span class="font-semibold">{{ child.receipt_number }}</span></p>
                                    {% endif %}
                                </div>
                            </div>
                            {% comment %}Inline documents: separate receipt vs final docs{% endcomment %}
                            {% if child.documents.all %}
                            <div class="mt-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white/10 rounded-lg p-3 border border-white/20">
                                        <p class="text-[11px] font-semibold text-gray-200 mb-2 flex items-center">
                                            <i class="fas fa-receipt mr-1"></i> Receipt Documents
                                        </p>
                                        <ul class="space-y-2">
                                            {% for d in child.documents.all %}
                                                {% if d.is_receipt %}
                                                <li class="flex items-center justify-between bg-white/5 rounded p-2">
                                                    <div class="flex-1 min-w-0 mr-2">
                                                        <span class="text-[11px] text-white truncate block">{{ d.description|default:'Receipt' }}</span>
                                                        <span class="text-[10px] text-gray-300">{{ d.uploaded_at|date:'M d, Y' }}</span>
                                                    </div>
                                                    <a href="{{ d.file.url }}" target="_blank" class="text-[10px] px-2 py-1 bg-emerald-500/80 text-white rounded font-semibold hover:bg-emerald-600 whitespace-nowrap">
                                                        <i class="fas fa-eye mr-1"></i>View
                                                    </a>
                                                </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="bg-white/10 rounded-lg p-3 border border-white/20">
                                        <p class="text-[11px] font-semibold text-gray-200 mb-2 flex items-center">
                                            <i class="fas fa-file-alt mr-1"></i> Supporting Documents
                                        </p>
                                        <ul class="space-y-2">
                                            {% for d in child.documents.all %}
                                                {% if not d.is_receipt %}
                                                <li class="flex items-center justify-between bg-white/5 rounded p-2">
                                                    <div class="flex-1 min-w-0 mr-2">
                                                        <span class="text-[11px] text-white truncate block">{{ d.description|default:'Supporting Doc' }}</span>
                                                        <span class="text-[10px] text-gray-300">{{ d.uploaded_at|date:'M d, Y' }}</span>
                                                    </div>
                                                    <a href="{{ d.file.url }}" target="_blank" class="text-[10px] px-2 py-1 bg-indigo-500/80 text-white rounded font-semibold hover:bg-indigo-600 whitespace-nowrap">
                                                        <i class="fas fa-eye mr-1"></i>View
                                                    </a>
                                                </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="mt-4 bg-white/5 rounded-lg p-3 border border-white/10">
                                <p class="text-[11px] text-gray-300 italic text-center">
                                    <i class="fas fa-info-circle mr-1"></i>No documents uploaded yet for this linked property.
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        {% empty %}
                        <p class="text-sm text-gray-200">No linked property cases.</p>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if case.parent_case and not is_active_quotation %}
                <div class="bg-white/20 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/30">
                    <div class="bg-gradient-to-r from-slate-500/80 to-slate-700/80 px-6 py-4 border-b border-white/20">
                        <h3 class="text-sm font-semibold text-white tracking-wide">Parent Case</h3>
                    </div>
                    <div class="p-4 flex items-center justify-between text-sm">
                        <div>
                            <p class="font-medium text-white">{{ case.parent_case.case_number }}</p>
                            <p class="text-xs text-gray-200">{{ case.parent_case.legal_reference_number|default:'No LRN yet' }}</p>
                        </div>
                        <a href="{% url 'case_detail' case.parent_case.id %}" class="text-indigo-300 text-xs font-semibold hover:underline">View Parent</a>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="space-y-8">
                <!-- Receipt & Billing (Admin only) -->
                {% if is_admin %}
                {% if case.receipt_number or case.receipt_amount or case.receipt_expense %}
                <div class="bg-white/20 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/30">
                    <div class="bg-gradient-to-r from-emerald-500/80 to-teal-600/80 px-6 py-5 border-b border-white/20">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-receipt text-2xl mr-3"></i>
                            Receipt & Billing
                        </h2>
                    </div>
                    <div class="p-6 space-y-3 text-sm">
                        {% if case.receipt_number %}
                        <div class="flex items-center justify-between">
                            <span class="text-gray-200">Receipt No.</span>
                            <span class="font-semibold text-white">{{ case.receipt_number }}</span>
                        </div>
                        {% endif %}
                        {% if case.receipt_amount and is_admin %}
                        <div class="flex items-center justify-between">
                            <span class="text-gray-200">Receipt Amount</span>
                            <span class="font-semibold text-white">₹ {{ case.receipt_amount }}</span>
                        </div>
                        {% endif %}
                        {% if case.receipt_expense %}
                        <div class="flex items-center justify-between">
                            <span class="text-gray-200">Receipt Expense</span>
                            <span class="font-semibold text-white">₹ {{ case.receipt_expense }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endif %}
                <!-- Actions Sidebar -->
                {% if not is_sro %}
                <div class="bg-white/20 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/30">
                    <div class="bg-gradient-to-r from-purple-500/80 to-pink-600/80 px-6 py-5 border-b border-white/20">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-bolt text-2xl mr-3"></i>
                            Actions
                        </h2>
                    </div>
                    <div class="p-6 space-y-3">
                        {% if is_active_quotation %}
                        <a href="{% url 'finalize_quotation' case.id %}" class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-gradient-to-r from-emerald-600 to-green-600 text-white font-semibold rounded-lg hover:from-emerald-700 hover:to-green-700 transition-all">Finalize Quotation</a>
                        {% endif %}
                        {% if case.assigned_advocate and not is_active_quotation %}
                        <a href="{% url 'work_on_case' case.id %}" class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-semibold rounded-lg hover:from-indigo-700 hover:to-blue-700 transition-all">Work on Case</a>
                        {% if case.status == 'document_pending' or case.status == 'sro_document_pending' %}
                        <a href="{% url 'case_finalize_with_document' case.id %}" class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-gradient-to-r from-blue-600 to-pink-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-pink-700 transition-all">Upload Final & Status</a>
                        {% if case.status == 'draft' %}
                        <a href="{% url 'case_finalize_as_draft' case.id %}" class="mt-2 w-full inline-flex items-center justify-center px-4 py-2.5 bg-amber-600 text-white font-semibold rounded-lg hover:bg-amber-700 transition-all">Upload Draft Document</a>
                        {% elif case.status == 'query' %}
                        <a href="{% url 'case_finalize_as_query' case.id %}" class="mt-2 w-full inline-flex items-center justify-center px-4 py-2.5 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition-all">Upload Query Document</a>
                        {% endif %}
                        {% endif %}
                        {% if case.status == 'pending_assignment' or case.status == 'pending' or case.status == 'draft' or case.status == 'query' %}
                            {% if case.status == 'draft' or case.status == 'query' %}
                            <a href="{% url 'case_reopen' case.id %}" class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-all">Reopen Case</a>
                            {% endif %}
                        {% endif %}
                        <a href="{% url 'case_add_document' case.id %}" class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all">Add Additional Document</a>
                        {% if not is_finalized %}
                            {% if request.user.groups.all.0.name == 'ADMIN' or request.user.groups.all.0.name == 'CO-ADMIN' or request.user.is_superuser %}
                            <a href="{% url 'add_case_work' case.id %}" class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-gradient-to-r from-emerald-600 to-green-600 text-white font-semibold rounded-lg hover:from-emerald-700 hover:to-green-700 transition-all">
                                Add Work (Case Type)
                            </a>
                            {% endif %}
                        {% endif %}
                        <a href="{% url 'add_child_case' case.id %}" class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-gradient-to-r from-indigo-600 to-blue-600 text-white font-semibold rounded-lg hover:from-indigo-700 hover:to-blue-700 transition-all">Add Child Case</a>
                        {% endif %}
                        {% if is_admin and not is_active_quotation %}
                        <a href="{% url 'admin_change_case_status' case.id %}" class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-gradient-to-r from-purple-600 to-violet-600 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-violet-700 transition-all shadow-lg">
                            <i class="fas fa-exchange-alt mr-2"></i>Change Status
                        </a>
                        <a href="{% url 'reassign_case_advocate' case.id %}" class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-gradient-to-r from-amber-600 to-orange-600 text-white font-semibold rounded-lg hover:from-amber-700 hover:to-orange-700 transition-all">Reassign Advocate</a>
                        <a href="{% url 'delete_case' case.id %}" class="w-full inline-flex items-center justify-center px-4 py-2.5 bg-gradient-to-r from-red-600 to-pink-600 text-white font-semibold rounded-lg hover:from-red-700 hover:to-pink-700 transition-all">Delete Case</a>
                        {% endif %}
                        
                    </div>
                </div>
                {% endif %}

                <!-- Case Timeline -->
                {% if not is_active_quotation %}
                <div class="bg-white/20 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/30">
                    <div class="bg-gradient-to-r from-indigo-600 to-blue-600 px-6 py-5 border-b border-white/20 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas fa-history text-2xl mr-3"></i>
                            Detailed Timeline
                        </h2>
                        <button id="toggle-timeline" type="button" class="px-4 py-2 bg-white/30 backdrop-blur-sm text-white font-semibold rounded-lg border border-white/40 hover:bg-white/40 transition-all shadow-lg">
                            Show Timeline
                        </button>
                    </div>
                    <div class="p-6 bg-gray-900/30" id="timeline-content" style="display:none;">
                        <div class="flow-root">
                            <ul class="-mb-8 space-y-1">
                                <!-- Case Created -->
                                <li>
                                    <div class="relative pb-8">
                                        <span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gradient-to-b from-white/40 to-transparent"></span>
                                        <div class="relative flex space-x-4">
                                            <div class="h-10 w-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center ring-4 ring-white/20 shadow-lg">
                                                <i class="fas fa-plus text-white"></i>
                                            </div>
                                            <div class="min-w-0 flex-1 bg-gray-800/60 p-4 rounded-lg border border-white/20">
                                                <div class="flex items-center justify-between mb-1">
                                                    <p class="text-base font-bold text-white">Case Created</p>
                                                    <span class="text-sm text-gray-300">{{ case.created_at|date:"M d, Y" }}</span>
                                                </div>
                                                <p class="text-sm text-gray-400">{{ case.created_at|date:"h:i A" }}</p>
                                                <p class="text-sm text-gray-300 mt-2">Case initiated and assigned for processing</p>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                
                                <!-- Advocate Assigned -->
                                {% if case.assigned_advocate %}
                                <li>
                                    <div class="relative pb-8">
                                        <span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gradient-to-b from-white/40 to-transparent"></span>
                                        <div class="relative flex space-x-4">
                                            <div class="h-10 w-10 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center ring-4 ring-white/20 shadow-lg">
                                                <i class="fas fa-user-tie text-white"></i>
                                            </div>
                                            <div class="min-w-0 flex-1 bg-gray-800/60 p-4 rounded-lg border border-white/20">
                                                <div class="flex items-center justify-between mb-1">
                                                    <p class="text-base font-bold text-white">Advocate Assigned</p>
                                                    {% if case.assigned_at %}
                                                    <span class="text-sm text-gray-300">{{ case.assigned_at|date:"M d, Y" }}</span>
                                                    {% endif %}
                                                </div>
                                                {% if case.assigned_at %}
                                                <p class="text-sm text-gray-400">{{ case.assigned_at|date:"h:i A" }}</p>
                                                {% endif %}
                                                <div class="flex items-center mt-2">
                                                    <i class="fas fa-user text-green-400 mr-2"></i>
                                                    <p class="text-sm text-white font-medium">{{ case.assigned_advocate.name }}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                {% endif %}
                                
                                <!-- All Updates -->
                                {% for update in updates %}
                                <li>
                                    <div class="relative pb-8">
                                        {% if not forloop.last %}
                                        <span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gradient-to-b from-white/40 to-transparent"></span>
                                        {% endif %}
                                        <div class="relative flex space-x-4">
                                            <div class="h-10 w-10 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-full flex items-center justify-center ring-4 ring-white/20 shadow-lg">
                                                {% if update.action == 'positive' %}
                                                <i class="fas fa-check-circle text-white"></i>
                                                {% elif update.action == 'negative' %}
                                                <i class="fas fa-times-circle text-white"></i>
                                                {% elif update.action == 'pending' or update.action == 'hold' %}
                                                <i class="fas fa-pause-circle text-white"></i>
                                                {% elif update.action == 'query' or update.action == 'document_query' %}
                                                <i class="fas fa-question-circle text-white"></i>
                                                {% else %}
                                                <i class="fas fa-info-circle text-white"></i>
                                                {% endif %}
                                            </div>
                                            <div class="min-w-0 flex-1 bg-gray-800/60 p-4 rounded-lg border border-white/20">
                                                <div class="flex items-center justify-between mb-1">
                                                    <p class="text-base font-bold text-white">{{ update.get_action_display }}</p>
                                                    <span class="text-sm text-gray-300">{{ update.update_date|date:"M d, Y" }}</span>
                                                </div>
                                                <p class="text-sm text-gray-400">{{ update.update_date|date:"h:i A" }}</p>
                                                
                                                {% if update.updated_by %}
                                                <div class="flex items-center mt-2">
                                                    <i class="fas fa-user text-purple-400 mr-2"></i>
                                                    <p class="text-sm text-white">By: <span class="font-medium">{{ update.updated_by.get_full_name|default:update.updated_by.username }}</span></p>
                                                </div>
                                                {% endif %}
                                                
                                                {% if update.remark %}
                                                <div class="mt-3 bg-gray-900/50 p-3 rounded border border-white/10">
                                                    <p class="text-xs text-gray-400 uppercase mb-1">Remark</p>
                                                    <p class="text-sm text-gray-200">{{ update.remark }}</p>
                                                </div>
                                                {% endif %}
                                                
                                                {% if is_admin and update.receipt_expense %}
                                                <div class="mt-2 flex items-center">
                                                    <i class="fas fa-receipt text-yellow-400 mr-2"></i>
                                                    <p class="text-sm text-yellow-300 font-medium">Receipt: ₹{{ update.receipt_expense }}</p>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                {% empty %}
                                {% if not case.assigned_advocate %}
                                <li>
                                    <div class="relative">
                                        <div class="min-w-0 flex-1 bg-gray-800/40 p-6 rounded-lg border border-white/20 text-center">
                                            <i class="fas fa-inbox text-gray-400 text-3xl mb-2"></i>
                                            <p class="text-sm text-gray-300">No updates recorded yet</p>
                                        </div>
                                    </div>
                                </li>
                                {% endif %}
                                {% endfor %}
                                
                                <!-- Case Completed -->
                                {% if case.completed_at %}
                                <li>
                                    <div class="relative">
                                        <div class="relative flex space-x-4">
                                            <div class="h-10 w-10 bg-gradient-to-br from-emerald-500 to-green-600 rounded-full flex items-center justify-center ring-4 ring-white/20 shadow-lg">
                                                <i class="fas fa-flag-checkered text-white"></i>
                                            </div>
                                            <div class="min-w-0 flex-1 bg-gray-800/60 p-4 rounded-lg border border-white/20">
                                                <div class="flex items-center justify-between mb-1">
                                                    <p class="text-base font-bold text-white">Case Completed</p>
                                                    <span class="text-sm text-gray-300">{{ case.completed_at|date:"M d, Y" }}</span>
                                                </div>
                                                <p class="text-sm text-gray-400">{{ case.completed_at|date:"h:i A" }}</p>
                                                <p class="text-sm text-emerald-300 mt-2">✓ Case successfully closed</p>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var btn = document.getElementById('toggle-timeline');
                    var content = document.getElementById('timeline-content');
                    btn.addEventListener('click', function() {
                        if (content.style.display === 'none') {
                            content.style.display = 'block';
                            btn.textContent = 'Hide Timeline';
                        } else {
                            content.style.display = 'none';
                            btn.textContent = 'Show Timeline';
                        }
                    });
                });
                </script>
            </div>
        </div>
    </div>
</div>
</body>
</html>


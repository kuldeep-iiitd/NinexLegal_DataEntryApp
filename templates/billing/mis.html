{% extends 'accounts/admin_base.html' %}
{% load static %}
{% block title %}MIS Reports - NinexLegal{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto">
  <!-- Page Header -->
  <div class="stat-card mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <div class="h-14 w-14 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-600 flex items-center justify-center text-white mr-4">
          <i class="fas fa-chart-bar text-xl"></i>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-gray-800">MIS - Case Reports</h1>
          <p class="text-gray-600">Generate detailed case listings with export</p>
        </div>
      </div>
      <a href="{% url 'billing_dashboard' %}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition-all">
        <i class="fas fa-arrow-left mr-2"></i>Back to Accounting
      </a>
    </div>
  </div>

  <!-- Step 1: Only ask for MIS By -->
  {% if not mode %}
  <div class="stat-card">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Select Report Type</h2>
    <form method="get" class="space-y-4">
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-2">How do you want to generate MIS?</label>
        <select name="by" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-cyan-500 focus:outline-none">
          <option value="bank">By Bank</option>
          <option value="branch">By Branch</option>
          <option value="sro">By SRO</option>
          <option value="advocate">By Advocate</option>
          <option value="case_type">By Case Type</option>
          <option value="state">By State</option>
        </select>
      </div>
      <button class="w-full bg-gradient-to-r from-cyan-500 to-teal-600 hover:from-cyan-600 hover:to-teal-700 text-white px-6 py-3 rounded-lg font-bold transition-all shadow-lg">Next <i class="fas fa-arrow-right ml-2"></i></button>
    </form>
    <p class="text-sm text-gray-600 mt-4"><i class="fas fa-info-circle mr-2"></i>Additional filters will be available in the next step</p>
  </div>
  {% endif %}

  <!-- Step 2: Show filters for the selected mode -->
  {% if mode %}
  <div class="stat-card mb-6">
    <form method="get" class="space-y-4">
      <input type="hidden" name="by" value="{{ mode }}" />
      
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-gray-800">Report Filters</h3>
        <a href="{% url 'mis_view' %}" class="inline-flex items-center text-sm text-cyan-600 hover:text-cyan-700 font-semibold">
          <i class="fas fa-arrow-left mr-2"></i>Change Report Type
        </a>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Start Date</label>
          <input type="date" name="start_date" value="{{ start_date }}" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-cyan-500 focus:outline-none"/>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">End Date</label>
          <input type="date" name="end_date" value="{{ end_date }}" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-cyan-500 focus:outline-none"/>
        </div>
        
        {% if mode == 'bank' %}
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Bank</label>
          <select name="bank" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-cyan-500 focus:outline-none">
            <option value="">All Banks</option>
            {% for b in banks %}
              <option value="{{ b.id }}" {% if bank_selected|add:'' == b.id|stringformat:'s' %}selected{% endif %}>{{ b.name }} ({{ b.state }})</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if mode == 'bank' or mode == 'branch' %}
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Branch</label>
          <select name="branch" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-cyan-500 focus:outline-none">
            <option value="">All Branches</option>
            {% for br in branches %}
              <option value="{{ br.id }}" {% if branch_selected|add:'' == br.id|stringformat:'s' %}selected{% endif %}>{{ br.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if mode == 'sro' %}
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">SRO</label>
          <select name="employee" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-cyan-500 focus:outline-none">
            <option value="">All SROs</option>
            {% for e in employees %}
              <option value="{{ e.id }}" {% if employee_selected|add:'' == e.id|stringformat:'s' %}selected{% endif %}>{{ e.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if mode == 'advocate' %}
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Advocate</label>
          <select name="advocate" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-cyan-500 focus:outline-none">
            <option value="">All Advocates</option>
            {% for a in advocates %}
              <option value="{{ a.id }}" {% if advocate_selected|add:'' == a.id|stringformat:'s' %}selected{% endif %}>{{ a.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if mode == 'case_type' %}
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Case Type</label>
          <select name="case_type" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-cyan-500 focus:outline-none">
            <option value="">All Types</option>
            {% for ct in case_types %}
              <option value="{{ ct.id }}" {% if case_type_selected|add:'' == ct.id|stringformat:'s' %}selected{% endif %}>{{ ct.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if mode == 'state' %}
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">State</label>
          <select name="state" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-cyan-500 focus:outline-none">
            <option value="">All States</option>
            {% for st in states %}
              <option value="{{ st.name }}" {% if state_selected == st.name %}selected{% endif %}>{{ st.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Status</label>
          <select name="status" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-cyan-500 focus:outline-none">
            <option value="">All Status</option>
            {% for code, label in statuses %}
              <option value="{{ code }}" {% if status_selected == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">Search</label>
          <input type="text" name="q" value="{{ q }}" placeholder="Case #, LRN, Applicant" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-cyan-500 focus:outline-none"/>
        </div>
      </div>

      <div class="flex gap-3 pt-2">
        <button class="bg-gradient-to-r from-cyan-500 to-teal-600 hover:from-cyan-600 hover:to-teal-700 text-white px-6 py-3 rounded-lg font-bold transition-all shadow-lg">
          <i class="fas fa-search mr-2"></i>Generate Report
        </button>
        <a href="?by={{ mode }}&start_date={{ start_date }}&end_date={{ end_date }}&bank={{ bank_selected }}&branch={{ branch_selected }}&employee={{ employee_selected }}&advocate={{ advocate_selected }}&case_type={{ case_type_selected }}&state={{ state_selected }}&status={{ status_selected }}&q={{ q }}&format=csv" class="bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white px-6 py-3 rounded-lg font-bold transition-all shadow-lg">
          <i class="fas fa-file-excel mr-2"></i>Export CSV
        </a>
        <a href="{% url 'billing_dashboard' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-bold transition-all">
          <i class="fas fa-arrow-left mr-2"></i>Back
        </a>
      </div>
    </form>
  </div>
  {% endif %}

  {% if rows %}
  <div class="stat-card overflow-hidden">
    <div class="mb-4">
      <h3 class="text-xl font-bold text-gray-800">Report Results</h3>
      <p class="text-sm text-gray-600">{{ rows|length }} cases found</p>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead>
          <tr class="bg-gradient-to-r from-blue-50 to-cyan-50 border-b-2 border-cyan-200">
            <th class="p-3 text-left text-sm font-bold text-gray-700">S.No</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">Date</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">Bank/NBFC</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">Branch</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">LRN No</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">File No</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">Applicant</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">Advocate</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">Status</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">Year</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">Receipt #</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">Completed</th>
            <th class="p-3 text-left text-sm font-bold text-gray-700">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr class="border-b border-gray-100 hover:bg-blue-50 transition-colors">
            <td class="p-3 text-sm">{{ forloop.counter }}</td>
            <td class="p-3 text-sm">{{ r.date }}</td>
            <td class="p-3 text-sm font-semibold text-blue-700">{{ r.bank }}</td>
            <td class="p-3 text-sm">{{ r.branch }}</td>
            <td class="p-3 text-sm">{{ r.lrn }}</td>
            <td class="p-3 text-sm">{{ r.file_no }}</td>
            <td class="p-3 text-sm">{{ r.applicant }}</td>
            <td class="p-3 text-sm">{{ r.advocate }}</td>
            <td class="p-3 text-sm">
              <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 font-semibold text-xs">{{ r.status }}</span>
            </td>
            <td class="p-3 text-sm">{{ r.year }}</td>
            <td class="p-3 text-sm">{{ r.receipt_number }}</td>
            <td class="p-3 text-sm">{{ r.completed_at }}</td>
            <td class="p-3 text-sm">
              <a href="{% url 'case_detail' r.obj.id %}" class="text-cyan-600 hover:text-cyan-700 font-semibold">
                <i class="fas fa-eye mr-1"></i>View
              </a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="16" class="p-8 text-center text-gray-500">
            <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i>
            <p>No cases found matching your filters.</p>
          </td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if rows %}
  <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
    <p class="text-sm text-blue-700"><i class="fas fa-info-circle mr-2"></i><strong>Note:</strong> Both root and child property cases are listed. Use CSV export for full data without UI limitations.</p>
  </div>
  {% endif %}
</div>
{% endblock %}
